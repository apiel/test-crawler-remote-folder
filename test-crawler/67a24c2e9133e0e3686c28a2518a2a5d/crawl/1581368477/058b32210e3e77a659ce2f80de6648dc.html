<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <title>test-crawler</title>
  <meta http-equiv="X-UA-Compatible" something="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" something="test-crawler is a tool for end to end testing, by crawling a website and making some snapshot comparison">
  <meta name="viewport" something="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <!-- Code highlight -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>

  <style>
    blockquote {
      background: #f1f8ff;
      padding: 6px 5px;
      border: 1px solid #EEE;
      border-radius: 9px;
      color: #323c65;
    }

    blockquote p {
      margin: 0;
    }

    code {
      font-size: 87.5%;
      color: #213752;
      word-break: break-word;
      background: #EEE;
      padding: 2px;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-light bg-light navbar-expand-sm">
    <div class="container" style="max-width: 800px;">
      <span class="navbar-brand mb-0 h1">Test-crawler</span>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarText">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="./live">
              Live
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/apiel/test-crawler" target="_blank" rel="noopener" aria-label="GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 499.36" focusable="false" style="width: 1rem; height: 1rem;">
                <title>GitHub</title>
                <path d="M256 0C114.64 0 0 114.61 0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34 0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49 0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75 0 0 21.49-6.88 70.4 26.24a242.65 242.65 0 0 1 128.18 0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69 0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41 0 34.22-.31 61.83-.31 70.23 0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37 0 256 0z" fill="currentColor" fill-rule="evenodd"></path>
              </svg></a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <br>
  <div class="container" style="max-width: 800px;">
    <div id="content"><p><strong><a href="https://apiel.github.io/test-crawler/live/">‚ñ∫ Try it directly on GitHub</a></strong></p>
<p>test-crawler is a tool for end to end testing, by crawling a website and making some snapshot comparison. Right now, it is mainly focus on visual regression testing but it will most likely support html comparison in the future.</p>
<h2>Getting started</h2>
<blockquote>
<p>üõà <strong>Note:</strong> you need to use at least node v11</p>
</blockquote>
<pre><code class="language-bash hljs">yarn global add <span class="hljs-built_in">test</span>-crawler
<span class="hljs-built_in">test</span>-crawler
</code></pre>
<p>Open url <a href="http://127.0.0.1:3005/">http://127.0.0.1:3005/</a> and create a new project:</p>
<p><img src="https://github.com/apiel/test-crawler/blob/master/screenshots/screenshot-new.png?raw=true" alt="screenshot-start"></p>
<p>There is two way to crawl pages:</p>
<ul>
<li><p><strong>Spider bot</strong> crawling method will get all the links inside the page of the given URL
and crawl the children. It will then continue do the same with the children till no new
link is found. Be careful if you have big website, this is most likely not the right
solution for you.</p></li>
<li><p><strong>URLs list</strong> crawling method will crawl a specific sets of URLs. In the URL input field
you must provide an endpoint containing a list of URLs (a simple text format, with one URL
per line). The crawler will crawl each of those URL only and will not try to find links in
the page.</p></li>
</ul>
<p>URLs list example:</p>
<pre><code class="hljs less"><span class="hljs-attribute">http</span>:<span class="hljs-comment">//127.0.0.1:3005/</span>
<span class="hljs-attribute">http</span>:<span class="hljs-comment">//127.0.0.1:3005/page1</span>
<span class="hljs-attribute">http</span>:<span class="hljs-comment">//127.0.0.1:3005/category/page33</span>
</code></pre>
<blockquote>
<p>üõà <strong>Note:</strong> to don‚Äôt get false visual differences, you must run your test always on the same environment. Diffrent OS, different graphic card, ‚Ä¶ might trigger visual differences in the snapshot, even if there was no changes. Prefer to always run your tests on the same machine.</p>
</blockquote>
<h2>Pins</h2>
<p>Pins are the references screenshot to make the comparison with. While crawling, the crawler is comparing page to pin. To create a pin go in the result page of your crawling result, each screenshot has some action buttons:</p>
<p><img src="https://github.com/apiel/test-crawler/blob/master/screenshots/screenshot-action-btn.png?raw=true" alt="screenshot-action-buttons"></p>
<p>click on the button on the right with little pin icon.</p>
<p>You can then visualize all your pins:</p>
<p><img src="https://github.com/apiel/test-crawler/blob/master/screenshots/screenshot-pins.png?raw=true" alt="screenshot-pins"></p>
<h2>Crawling result</h2>
<p><img src="https://github.com/apiel/test-crawler/blob/master/screenshots/screenshot-diff.png?raw=true" alt="screenshot-diff"></p>
<p>On the result page, you will see many screenshot with eventually some differences found. A difference is represented by a yellow rectangle. By clicking on the rectangle, popup 3 buttons giving you the possibility to report this difference (rectangle will became red) or validate this difference (rectangle will became green). You can as well validate this difference "for ever", then this area of the pages will always reconize this zone as valid place for changes.</p>
<blockquote>
<p><strong>Note:</strong> comparing page that are growing is very difficult (different height). For the moment this result to weird behaviors when comparing 2 screenshots of different size. To avoid this, use the code injection to remove the dynamic part of the page. Hopefully in the future, we will find better algarithm to reconize such changes.</p>
</blockquote>
<h2>Inject code</h2>
<p><img src="https://github.com/apiel/test-crawler/blob/master/screenshots/screenshot-code-new.png?raw=true" alt="screenshot-code"></p>
<p>Inject some code in the crawler while parsing the page. This code will be executed just after the page finish loaded, before to make the screenshot and before extracting the links.</p>
<p>This can be useful to remove some dynamic part from a page, for example some comments on a blog pages or some reviews on prodcut page. You could also inject code to simulate user behavior, like clicking or editing an input fields.</p>
<p>Test-crawler is using <a href="https://www.npmjs.com/package/puppeteer">Puppeteer</a> to crawl the page and make the screenshot. By injecting the code, you can use all the functionnalities from Puppeteer.</p>
<p>In the editor, you need to export a function that will get as params the page currently opened by Puppeteer.</p>
<pre><code class="language-js hljs javascript"><span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">page</span>) </span>{
<span class="hljs-comment">// your code</span>
}
</code></pre>
<p>You can then use this <code>page</code> variable to manipulate the page. Following is an example that will insert ‚ÄúTest-crawler is awesome!‚Äù on the top of the page:</p>
<pre><code class="language-js hljs javascript"><span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">page</span>) </span>{
    <span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);
        div.innerHTML = <span class="hljs-string">"Test-crawler is awesome!"</span>;
        <span class="hljs-built_in">document</span>.body.insertBefore(div, <span class="hljs-built_in">document</span>.body.firstChild);
    });
}
</code></pre>
<p>You can as well make some assertion. Any failed assertion will be displayed in the result page.</p>
<p><img src="https://github.com/apiel/test-crawler/blob/master/screenshots/screenshot-assertion.png?raw=true" alt="screenshot-assertion"></p>
<pre><code class="language-js hljs javascript"><span class="hljs-keyword">const</span> expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'expect'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">page</span>) </span>{
  <span class="hljs-keyword">await</span> expect(page.title()).resolves.toMatch(<span class="hljs-string">'React App'</span>);
  expect(<span class="hljs-string">'a'</span>).toBe(<span class="hljs-string">'b'</span>); <span class="hljs-comment">// fail</span>
}
</code></pre>
<p>By default <code>expect</code> library from <a href="https://jestjs.io/docs/en/expect.html">jest</a> is installed but you can use any library of your choice.</p>
<h2>Storybook</h2>
<p>You can use code injection to crawl storybooks. Say test-crawler to crawl your storybook url <a href="http://127.0.0.1:6006/">http://127.0.0.1:6006/</a> and then inject some code to extract the urls of the stories and transform them to there iframe version. The code should be something like that:</p>
<pre><code class="language-js hljs javascript"><span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">page</span>) </span>{
    <span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        hrefs = <span class="hljs-built_in">Array</span>.from(<span class="hljs-built_in">document</span>.links).map(
            <span class="hljs-function"><span class="hljs-params">link</span> =&gt;</span> link.href.replace(<span class="hljs-string">'/?'</span>, <span class="hljs-string">'/iframe.html?'</span>)
        );

        <span class="hljs-built_in">document</span>.body.innerHTML = hrefs.map(
            <span class="hljs-function"><span class="hljs-params">href</span> =&gt;</span> <span class="hljs-string">`&lt;a href="<span class="hljs-subst">${href}</span>"&gt;<span class="hljs-subst">${href}</span>&lt;/a&gt;`</span>
        ).join(<span class="hljs-string">'&lt;br /&gt;'</span>);
    });
}
</code></pre>
<p>You can find this code by clicking the button <code>Code snippet</code> of the code editor.</p>
<blockquote>
<p>üõà <strong>Note:</strong> feel free to make some pull request to propose some new code snippet.</p>
</blockquote>
<h2>Cli</h2>
<p>You can run test directly from the cli. This can be useful for continuous integration test.</p>
<pre><code class="language-bash hljs"><span class="hljs-comment"># test-crawler-cli --project the_id_of_the_project</span>
<span class="hljs-built_in">test</span>-crawler-cli --project f0258b6685684c113bad94d91b8fa02a
</code></pre>
<h2>Continuous integration</h2>
<p>As mentioned before, to don‚Äôt get false visual differences, you must run your test always on the same environment. The best way to solve this is to include test-crawler in your continue integration, with
some tools like Travis or GitHub actions. Test-crawler is already supporting out of the box Github
actions. In order to run test-crawler in the CI container, you must use <code>test-crawler-cli</code>.</p>
<p>Example of GitHub action:</p>
<pre><code class="language-yml hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Test-crawler</span> <span class="hljs-string">CI</span>

<span class="hljs-attr">on:</span> <span class="hljs-string">[push]</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>

    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">node</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v1</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">test-crawler</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">|
        ROOT_FOLDER=`pwd` npx -p test-crawler test-crawler-cli --project ${{ github.event.client_payload.projectId }}
</span>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Commit</span> <span class="hljs-string">changes</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">|
        git config --local user.email "action@github.com"
        git config --local user.name "Test-crawler"
        git add .
        git status
        git commit -m "[test-crawler] CI save" || echo "No changes to commit"
        git pull
        git push "https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
</span></code></pre>
<h2>Contribution</h2>
<p>If you are interested to work on this project, you are really welcome.
There is many way to bring help, testing, documentation, bug fixes, new features‚Ä¶</p>
<p>For the one who want to dive in the code, you need to know about TypeScript, React and eventually Puppeteer but <strong>the most important thing to be aware is that test-crawler is base on <a href="https://www.npmjs.com/package/isomor">isomor</a></strong>. It might be useful to undertsand the concept of this tool before to touch the code.</p>
<p>Since you was reading the doc, you now know that the code should be modified in "src-isomor".</p>
<p>To start the project in dev mode:</p>
<pre><code class="language-shell hljs">git clone https://github.com/apiel/test-crawler.git
cd test-crawler
npx lerna bootstrap
cd packages/test-crawler
yarn dev
</code></pre>
<p><code>yarn dev</code> will start 3 processes using <a href="https://www.npmjs.com/package/run-screen">run-screen</a>. The first process is the isomor-transpiler, the second is the backend server and the third is react server. To switch between process, press 1, 2 or 3.</p>
<p>If you have any question, feel free to contact me at <a href="mailto:alexandre.piel@gmail.com">alexandre.piel@gmail.com</a></p>
</div>
  </div>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <script>hljs.initHighlightingOnLoad();</script>


</body></html>